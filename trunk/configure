#!/usr/bin/perl

# Chained's new configure script ... thanks to InspIRCd for saving me a lot of manual reading :P

$last_makeinstall = "/opt/chained";

if ( -f "./config.lastrun")
{
  eval { do "./config.lastrun"; }
}

open(LR, ">", "config.lastrun~") or die("lr open failed");

$libs = "-lm -lc";
$modules = "";
$location = `pwd`;

print "When prompted, please enter your choice from the square brackets.
Your previous answers are displayed in parenthese.
Hitting enter will cause it to use your previous answer.


Detecting OS requirements...
============================

Looking for dl... ";
if (-f "/usr/lib/libdl.a")
{
  print "found, using -ldl\n";
  $DL = 1;
  $libs .= " -ldl"
}
else
{
  print "not found.\n";
  $DL = 0;
}

print "
Attempting to detect OS capabilities
====================================

Where would you like \"make install\" to install to? ($last_makeinstall) ";

chomp($makeinstall = <STDIN>);
if ($makeinstall eq "") { $makeinstall = $last_makeinstall; }

$makeinstall =~ s/\/*$//;

print LR "\$last_makeinstall='$makeinstall'";

#############################

close LR;
rename "config.lastrun~", "config.lastrun";
system "mkdir -p $makeinstall";

#######################################################################
#######################################################################
#######################################################################

print "\nCreating Makefiles...\n";

#####################################

print "> src/includes/Make_config\n";

chdir "src/includes/";

open(MC, ">Make_config");

print MC "CC = gcc
CFLAGS = -export-dynamic -g -fPIC -pipe -I\$(INCLUDE_DIR)
LIBS = $libs
INCLUDES = ";

open (GREP, 'grep -L "CHAINED: IGNORE" *.h|');
while (<GREP>)
{
  $f = $_;
  chomp($f);
  print MC " \\\n \$(INCLUDE_DIR)$f";
}
print MC "\n";
close GREP;
close MC;

chdir "..";

####################################

print "> src/Makefile\n";

print "> > Generating object list\n";

open(MF, ">Makefile");

$OBJS = "";
open(GREP, 'grep -LE "CHAINED: (IGNORE|NORULE)" *.c |');
while (<GREP>)
{
  $f = $_;
  chomp($f);
  $f =~ s/\.c$/.o/;
  $OBJS .= " $f";
}
close GREP;

print MF "INCLUDE_DIR = includes/

include \$(INCLUDE_DIR)Make_config
OBJS = $OBJS

all:	\$(OBJS)
	\$(CC) \$(CFLAGS) \$(LIBS) -shared -o libchained.so \$(OBJS)

# ----

\$(OBJS):	\$(INCLUDES)

# ----

clean:
	rm -f *.o *.so

# ----

install:
	mkdir -p $makeinstall/libs
	cp *.so $makeinstall/libs
	mkdir -p $makeinstall/includes
	cp -r includes/*.h includes/types $makeinstall/includes
";

close MF;

chdir "..";
#####################################

print "> echo/Makefile\n";

chdir "echo";

open (MF, ">Makefile");

print MF "all: echo

echo: echo.c
	gcc -L$makeinstall/libs -Wl,--rpath -Wl,$makeinstall/libs -lchained -g -fPIC -I$makeinstall/includes/ -o echo echo.c

clean:
	rm echo
";

close MF;

chdir "..";

#####################################

print "
------------------------------
       Config complete.
------------------------------
";
